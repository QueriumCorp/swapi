#------------------------------------------------------------------------------
# written by: Lawrence McDaniel
#             https://lawrencemcdaniel.com
#
# date:       sep-2022
# usage:      Build and upload a Docker container for SWAPI (dev or prod)
#------------------------------------------------------------------------------
name: build and push a SWAPI container
description: 'build a SWAPI Docker container and push to AWS ECR'
branding:
  color: 'orange'
  icon: 'cloud'
inputs:
  aws-ecr-repository:
    description: 'The SWAPI AWS ECR repository URI. Example: swapi-prod'
    required: true
    type: string
outputs:
runs:
  using: "composite"
  steps:
    - uses: actions/checkout@v3.0.2

    - name: Set up Docker Buildx
      id: setup-docker
      uses: docker/setup-buildx-action@v2

    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v1.5.1

    # verify that the ECR repository exists. If not, then create it.
    # written and maintained by Lawrence McDaniel
    - name: Create the AWS ECR repository
      id: create-repository
      uses: lpm0073/aws-ecr-create@v0.1.1
      with:
        aws-ecr-repository: ${{ inputs.aws-ecr-repository }}

    - name: Intialize environment variables
      id: init-env
      shell: bash
      run: |
        echo "AWS_ECR_REGISTRY=${{ steps.login-ecr.outputs.registry }}" >> $GITHUB_ENV
        echo "AWS_ECR_REPOSITORY_SWAPI=${{ inputs.aws-ecr-repository }}" >> $GITHUB_ENV
        echo "REPOSITORY_TAG_SWAPI=$TUTOR_VERSION-$(date +%Y%m%d%H%M)" >> $GITHUB_ENV

    - name: Initialize Docker image URI
      id: init-docker-image
      shell: bash
      run: |
        echo "DOCKER_IMAGE_SWAPI=${AWS_ECR_REGISTRY}/${AWS_ECR_REPOSITORY_SWAPI}:${REPOSITORY_TAG_SWAPI}" >> $GITHUB_ENV

    # Note: This is scaffolding. This step initialize the tutor 'env' path, which you might need
    #       if for example, you need to add Python requirements to the image
    - name: Render Tutor Config
      id: tutor-config-save
      shell: bash
      run: tutor config save --set SWAPI_DOCKER_IMAGE=${DOCKER_IMAGE_SWAPI}


    - name: Build the image
      id: tutor-build-image
      shell: bash
      run: echo "build a docker image"

    - name: Push the image
      id: docker-push-image
      shell: bash
      run: |-
        echo "push the docker image"
        # tutor images push credentials
        # docker tag ${AWS_ECR_REGISTRY}/${AWS_ECR_REPOSITORY_SWAPI}:${REPOSITORY_TAG_SWAPI} ${AWS_ECR_REGISTRY}/${AWS_ECR_REPOSITORY_SWAPI}:latest
        # docker push ${AWS_ECR_REGISTRY}/${AWS_ECR_REPOSITORY_SWAPI}:latest

    - name: Docker image:tag
      id: docker-image
      shell: bash
      run: |-
        echo "tag the Docker image"
        echo "::set-output name=uri::$(echo $DOCKER_IMAGE_SWAPI)"
